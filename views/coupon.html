<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>coupon</title>
    <script>
        // document.querySelector(".side_info").innerHTML = ''
        window.addEventListener('DOMContentLoaded', function(){
            let cancle_year = `{{seat.year}}`
            let cancle_month = `{{seat.month}}`
            let cancle_date = "{{seat.day}}"-1
            let cancle_ticket = new Date(`${cancle_year}-${cancle_month}-${cancle_date}`)
            console.log(cancle_ticket)
            document.querySelector(".cancle_time").innerHTML += `${cancle_ticket.getFullYear()}년 ${cancle_ticket.getMonth()+1}월 ${cancle_ticket.getDate()}일`
            // if (cancle_date == 1){
            //     console.log('첫날')
            // }
            // else {
            //     cancle_date -= 1
            //     console.log(cancle_date)
            // }
            let cnt = "{{cnt}}"
            let totprice = "{{ptot}}"
            let use = 0
            let arr = []
            let hidden = document.querySelector(".hidden")
            
            document.querySelector(".total_price_btn").value = totprice+"원 결제하기"
            document.querySelectorAll(".coupon_ck").forEach(cck =>{
                cck.addEventListener('change', ()=>{
                    let checkedValues = []
                    
                    document.querySelectorAll(".coupon_ck").forEach(cb =>{
                        if (cb.checked) {
                            checkedValues.push(`${cb.classList[1]} ${cb.classList[2]}`)
                        }
                    })

                    // document.querySelector(".use_coupon").innerHTML += cck.classList[1]
                    // document.querySelector(".use_coupon").innerHTML += cck.classList[2]
                    console.log(checkedValues)
                    document.querySelector(".use_coupon").innerHTML = ``
                    document.querySelector(".use_coupon").innerHTML += checkedValues
                    document.querySelector(".use_coupon").innerHTML += `<br/>`
                })

                cck.addEventListener('click', ()=>{
                    if (cck.checked == true){
                        use++
                        totprice -= eval(cck.classList[2])
                        arr.push(
                            {
                                coupon_name: cck.classList[1],
                                discount_price: cck.classList[2]
                            }
                        )
                        hidden.value = JSON.stringify(arr)

                        if (use > cnt){
                            alert('쿠폰 선택 안됨')
                            cck.checked = false
                            use--
                            totprice += eval(cck.classList[2])
                            arr.pop()
                            hidden.value = JSON.stringify(arr)
                        }
                        document.querySelector(".total_price_btn").value = totprice+"원 결제하기"
                    }
                    else {
                        use--
                        totprice += eval(cck.classList[2])
                        arr.pop()
                        hidden.value = JSON.stringify(arr)

                        document.querySelector(".total_price_btn").value = totprice+"원 결제하기"
                    }
                })
            })

            let frm = document.forms.frm
            document.querySelector(".total_price_btn").onclick = function() {
                frm.submit()
            }
            
        })

        
    </script>
</head>
<body>
    <h1>coupon데이터</h1>
    <div class="coupon_menu">
        {% for i in coupon %}
        <label>
        <input type="checkbox" class="coupon_ck {{i.coupon_name}} {{i.discount_price}}">
        {{i.cid}} {{i.coupon_name}} {{i.discount_price}}<br/>
        </label>
        {% endfor %}

    </div>
    <div class="side_info">
        <div calss="perf_info">
            뮤지컬〈{{perf.name}}〉<br/>
            <img src="../../img/{{perf.poster_url}}"><br/>
            공연기간 {{perf.start_date}} ~ {{perf.end_date}} <br/>
            장르 {{perf.genre}} <br/>
            러닝타임 {{perf.running_time}}분
        </div>
        <div class="ticket_info">
            {{seat.year}} {{seat.month}} {{seat.day}} {{seat.choice_time}}회차
            <br/>
            {% for i in temp_data %}
            좌석등급 {{i.grade}} {{i.area}}구역 {{i.s_row}}열 {{i.s_col}} {{i.price}}원<br/>
            {% endfor %}
            
        </div>
        사용한 쿠폰<br/>
        <div class="use_coupon">
        </div>
        취소시간<br/>
        <div class="cancle_time">
        </div>

    </div>
    <form action="/desc/payment" name="frm" method="POST">
        <input type="hidden" name="items" class="hidden">
    <input type="submit" class="total_price_btn" value="{{ptot}}원 결제하기">
    </form>
</body>
</html>