<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì›ê°€ì…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        header,
        footer {
            width: 1200px;
            background-color: #ff0;
        }

        wrapper {
            width: 800px;
            height: 700px;

            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin: 40px auto;
            padding: 30px 25px;
            display: block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);


        }

        select {
            text-align: center;

        }

        .joinmem {
            width: 50%;
            margin: auto;
        }

        /* ê³µí†µ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            height: 40px;
            margin: 8px 0;
            padding: 0 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        /* ì´ë©”ì¼ ì˜ì—­ */
        .email-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }


        #email1 {
            flex: 1.2;
            /* ì•½ê°„ ë„“ê²Œ */
            height: 38px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 0 10px;
            font-size: 14px;
        }


        #email2 {
            flex: 0.9;
            height: 38px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 0 6px;
            font-size: 14px;
        }

        h2 {
            text-align: center;
            font-weight: 400;
        }

        .logo>a>img {
            width: 100px;
            height: 100px;
            display: block;
            margin: auto;
        }

        /* ì¤‘ë³µí™•ì¸ ë²„íŠ¼ */
        #emailoverlap {
            flex: 0.7;
            height: 35px;
            background-color: #0d47a1;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
        }

        #emailoverlap:hover {
            background-color: #1565c0;
        }

        /* ì¸ì¦ë²ˆí˜¸ ë°›ê¸° ë²„íŠ¼ */
        #confirmcode {
            width: 100%;
            height: 35px;
            background-color: #0d47a1;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 5px 0;
            cursor: pointer;
        }


        #confirmcode:hover {
            background-color: #1565c0;
        }

        #authSection {
            margin-top: 10px;
            display: none;
        }

        #code {
            width: 100%;
            height: 38px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 0 10px;
        }

        #checkCodeBtn {
            width: 100%;
            height: 35px;
            background-color: #0d47a1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }


        .verify-finish {
            width: 100%;
            height: 45px;
            background-color: #0d47a1;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 16px;
        }

        /* ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸ */
        #pwEqChk {
            color: red;
            font-size: 13px;
            display: none;
            margin-top: 4px;
            text-align: center;
        }

        /* ê°€ì… ì™„ë£Œ ë²„íŠ¼ */
        #submit {
            width: 100%;
            height: 45px;
            margin-top: 15px;
            background-color: #0d47a1;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #submit:hover {
            background-color: #1565c0;
        }

        .loginLogo {
      width: 100px;
      height: 100px;
      display: block;
      margin: auto;
    }

    .logo {
      text-align: center;
      text-decoration: none;
      color: black;
    }
    </style>

    <script>
        window.onload = function () {

            let emailChecked = false
            //----------------------------------------------------------------------------------------------- ì´ë©”ì¼ ì¤‘ë³µí™•ì¸
            document.querySelector("#emailoverlap").onclick = function () {


                const params = {
                    email1: document.querySelector("#email1").value,
                    email2: document.querySelector("#email2").value
                }

                if (!email1 || !email2) {
                    alert('ì´ë©”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”')
                    return
                }


                let ttt = JSON.stringify(params)
                console.log(params)
                console.log(ttt)

                fetch(`/joinmem/emailoverlap`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'

                    },
                    body: ttt

                })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message)
                        console.log('ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ :', data)

                        if (data.success) {
                            emailChecked = true

                            document.querySelector('#email1').readOnly = true
                            document.querySelector('#email2').disabled = true
                            document.querySelector('#emailoverlap').disabled = true
                        } else {
                            emailChecked = false
                        }
                    })
                    .catch(err => console.log('ì—ëŸ¬ :', err.message))
            }

            document.querySelector('#email1').addEventListener('input', () => emailChecked = false)
            document.querySelector('#email2').addEventListener('change', () => emailChecked = false)

            //----------------------------------------------------------------------------------------------- ì´ë©”ì¼ ì¸ì¦
            document.querySelector("#confirmcode").onclick = function () {

                const email1 = document.querySelector("#email1").value
                const email2 = document.querySelector("#email2").value

                if (!email1 || !email2) {
                    alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')
                    return
                }

                const email = email1 + email2

                document.getElementById('authSection').style.display = 'block';

                fetch(`/joinmem/sendEmail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                })
                    .then(res => res.json())
                    .then(data => alert(data.message))
                    .catch(err => console.log('ì—ëŸ¬ :', err.message));
            }

            // -----------------------------------------------------------------------------------------------
            // ë²„íŠ¼ í´ë¦­ ì‹œ ì¸ì¦ í™•ì¸
            document.querySelector("#checkCodeBtn").onclick = function () { // ì¸ì¦ ë²„íŠ¼ í´ë¦­ ì‹œ í™•ì¸
                const email = document.querySelector("#email1").value + document.querySelector("#email2").value;
                const code = document.querySelector("#code").value;

                fetch(`/joinmem/verifyCode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message)
                        if (data.success) {
                            document.querySelector('#code').readOnly = true
                            document.querySelector('#confirmcode').disabled = true
                            document.querySelector('#checkCodeBtn').disabled = true
                        }
                    })
                    .catch(err => console.log('ì—ëŸ¬ :', err.message));
            };

            // -----------------------------------------------------------------------------------------------
            // ì¸ì¦ë²ˆí˜¸ ì…ë ¥ ì‹œ ê²€ì¦
            // document.querySelector("#code").addEventListener('change', function () {
            //     const email = document.querySelector("#email1").value + document.querySelector("#email2").value;
            //     const code = document.querySelector("#code").value;

            //     fetch(`/joinmem/verifyCode`, {
            //         method: 'POST',
            //         headers: { 'Content-Type': 'application/json' },
            //         body: JSON.stringify({ email, code })
            //     })
            //         .then(res => res.json())
            //         .then(data => alert(data.message))
            //         .catch(err => console.log('ì—ëŸ¬ :', err.message));
            // });
            //----------------------------------------------------------------------------------------------- ê°€ì…ì™„ë£Œ
            let myFrm = document.forms.myFrm
            let pwEqChk = document.querySelector('#pwEqChk')
            let pw1 = document.querySelector('#pw1')
            let pw2 = document.querySelector('#pw2')

            myFrm.addEventListener('submit', e => e.preventDefault())

            myFrm.addEventListener('submit', (e) => {
                e.preventDefault()
                if (pw1.value != pw2.value) {
                    pwEqChk.style.display = 'block'
                    return;
                }

                myFrm.submit()
            })
            //----------------------------------------------------------------------------------------------- ê°€ì…ì™„ë£Œ ë²„íŠ¼ í´ë¦­ì‹œ
            document.querySelector("#submit").onclick = function (e) {
                e.preventDefault();

                const pw1 = document.querySelector("#pw1").value;
                const pw2 = document.querySelector("#pw2").value;
                const pwEqChk = document.querySelector('#pwEqChk');
                const question = document.querySelector("#question").value;
                const answer = document.querySelector("#answer").value

                if (!emailChecked) {
                    alert('ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸í•´ì£¼ì„¸ìš”')
                    return
                }

                if (!question) {
                    alert("ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                if (!answer) {
                    alert("ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const nameInput = document.querySelector("#name").value.trim(); // ğŸ”¹ name ë³€ìˆ˜ ì •ì˜ ì¶”ê°€
                const koreanName = /^[ê°€-í£]{1,10}$/; // í•œê¸€ 1~10ì
                const englishName = /^[a-zA-Z\s]+$/;  // ì˜ì–´ë§Œ (ë„ì–´ì“°ê¸° í¬í•¨ ê°€ëŠ¥)
                const onlyConsonants = /^[ã„±-ã…]+$/;  // ììŒë§Œ
                const onlyVowels = /^[ã…-ã…£]+$/;     // ëª¨ìŒë§Œ

                // ììŒ ë˜ëŠ” ëª¨ìŒë§Œ ì…ë ¥í•œ ê²½ìš°
                if (onlyConsonants.test(nameInput) || onlyVowels.test(nameInput)) {
                    alert("ì´ë¦„ì€ ììŒ ë˜ëŠ” ëª¨ìŒë§Œìœ¼ë¡œ êµ¬ì„±ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                // í•œê¸€(ìµœëŒ€ 10ì) ë˜ëŠ” ì˜ì–´ë§Œ í—ˆìš©
                else if (!koreanName.test(nameInput) && !englishName.test(nameInput)) {
                    alert("ì´ë¦„ì€ í•œê¸€(ìµœëŒ€ 10ì) ë˜ëŠ” ì˜ì–´ë¡œë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    return;
                }

                const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#&*])[A-Za-z\d!@#&*]{8,16}$/;
                if (!pwRegex.test(pw1)) {
                    alert("8~16ì, ì˜ë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì(!,@,#,&,*)ë¥¼ í¬í•¨í•´ì•¼í•©ë‹ˆë‹¤.");
                    return;
                }

                // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
                if (pw1 !== pw2) {
                    pwEqChk.style.display = 'block';
                    return;
                } else {
                    pwEqChk.style.display = 'none';
                }

                const params = {
                    email1: document.querySelector("#email1").value,
                    email2: document.querySelector("#email2").value,
                    email: document.querySelector("#email1").value + document.querySelector("#email2").value,
                    pw1: pw1,
                    pw2: pw2,
                    name: document.querySelector("#name").value,
                    question: question,
                    answer: answer
                }

                console.log("ê°€ì… ìš”ì²­ ë°ì´í„°:", params);

                fetch(`/joinmem/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                })
                    .then(res => res.json())
                    .then(data => {
                        console.log("ì„œë²„ ì‘ë‹µ:", data);
                        if (data.success) {
                            alert(data.message || "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            if (data.redirect) location.href = data.redirect;
                        } else {
                            alert(data.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    })
                    .catch(err => console.log('ì—ëŸ¬ :', err.message));
            }

        }
        //-----------------------------------------------------------------------------------------------



        // ê°€ì…ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ, ê°€ì… ì„±ê³µí‘œì‹œ ë˜ëŠ” ê°€ì… ì‹¤íŒ¨ í‘œì‹œ(ì•„ì´ë””ì¤‘ë³µ, ì¸ì¦ë²ˆí˜¸ ì…ë ¥ ì•ˆí•  ì‹œ, ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜, ë¹„ë°€ë²ˆí˜¸ ì–‘ì‹ ì•ˆë§ì„ ì‹œ, ì´ë¦„ ì–‘ì‹ ì•ˆë§ì„ ì‹œ)


    </script>
</head>

<body>
    <!--í—¤ë”-->
     {% include '../header.html' %}

    <wrapper>
        <!--íšŒì›ê°€ì…-->
        <section class="joinmem">
             <h2><a href="/main" class="logo" style="font-weight: bold;"><img src="../../img/malang_logo.png" alt="" class="loginLogo">íšŒì›ê°€ì…</a></h2>
            <div><br>
                <form action="/" method="post" name="myFrm">
                    <!--ì´ë©”ì¼-->
                    <div class="email-row">
                        <input type="text" id="email1" placeholder="ì•„ì´ë””(ì´ë©”ì¼)">
                        <select id="email2">
                            <option value="@naver.com">@naver.com</option>
                            <option value="@gmail.com">@gmail.com</option>
                        </select>
                        <button type="button" id="emailoverlap">ì¤‘ë³µí™•ì¸</button>
                    </div>
                    <!--ì¸ì¦ë²ˆí˜¸ ë°›ê¸° ë²„íŠ¼-->
                    <input type="button" id="confirmcode" value="ì¸ì¦ë²ˆí˜¸ ë°›ê¸°">
                    <!--ì¸ì¦ë²ˆí˜¸ ì…ë ¥ë€-->
                    <div id="authSection" style="display: none;">
                        <input type="text" id="code" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥">

                        <input type="button" id="checkCodeBtn" value="ì¸ì¦ í™•ì¸">
                        <br>
                    </div>
                    <!--ë¹„ë°€ë²ˆí˜¸-->
                    <input type="password" name="pw" id="pw1" placeholder="ë¹„ë°€ë²ˆí˜¸(8~16ì, ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì(!@#&*))">
                    <br>
                    <!--ë¹„ë°€ë²ˆí˜¸ í™•ì¸-->
                    <input type="password" name="pw2" id="pw2" placeholder="ë¹„ë°€ë²ˆí˜¸í™•ì¸">
                    <br>
                    <!--ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸-->
                    <div id="pwEqChk">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                    <input type="text" name="name" id="name" placeholder="ì´ë¦„">
                    <br>
                    <div>
                        <select id="question">
                            <option value="">---ì§ˆë¬¸ ì„ íƒ---</option>
                            <option value="food" class="question">ì–´ë–¤ ìŒì‹ì„ ì¢‹ì•„í•©ë‹ˆê¹Œ?</option>
                            <option value="hobby" class="question">ì–´ë–¤ ì·¨ë¯¸ê°€ ìˆìŠµë‹ˆê¹Œ?</option>
                            <option value="exercise" class="question">ì–´ë–¤ ìš´ë™ì„ ì¢‹ì•„í•©ë‹ˆê¹Œ?</option>
                            <option value="music" class="question">ì¢‹ì•„í•˜ëŠ” ìŒì•… ì¥ë¥´ëŠ” ë¬´ì—‡ì…ë‹ˆê¹Œ?</option>
                            <option value="season" class="question">ì¢‹ì•„í•˜ëŠ” ê³„ì ˆì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?</option>
                            <option value="trip" class="question">ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ì—¬í–‰ì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?</option>
                            <option value="animal" class="question">ì–´ë–¤ ë™ë¬¼ì„ ì¢‹ì•„í•©ë‹ˆê¹Œ?</option>
                            <option value="place" class="question">ì¶”ì–µì˜ ì¥ì†ŒëŠ” ì–´ë””ì…ë‹ˆê¹Œ?</option>
                            <option value="movie" class="question">ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì˜í™”ëŠ” ë¬´ì—‡ì…ë‹ˆê¹Œ?</option>
                            <option value="color" class="question">ì¢‹ì•„í•˜ëŠ” ìƒ‰ê¹”ì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?</option>
                        </select>
                        <br>
                        <input type="text" name="answer" id="answer" placeholder="ë‹µë³€">
                    </div>
                    <input type="button" value="ê°€ì…ì™„ë£Œ" id="submit">
                </form>
            </div>
        </section>
    </wrapper>
    <!--í‘¸í„°-->
    <footer>footer</footer>
</body>

</html>