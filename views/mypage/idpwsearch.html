<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아이디/비밀번호찾기</title>
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }

        
        footer {
            width: 100%;
            height: 80px;
            background-color: #ff0;
        }

        wrapper {
            display: flex;
            justify-content: space-around;
            width: 800px;
            height: 500px;
            margin: 40px auto;
            gap: 40px;
        }

        section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            flex: 1;
            text-align: center;
        }



        section:first-of-type input[type="text"],
        section:first-of-type select,
        section:first-of-type input[type="submit"] {
            width: 80%;
            height: 40px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            /* 이름, 질문, 답변, 버튼 동일 너비 */
        }

        section:first-of-type select {
            text-align: center;
        }

        section:first-of-type input[type="submit"] {
            height: 35px;
            background-color: #0d47a1;
            color: #fff;
            margin-top: 10px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
        }

        section:first-of-type input[type="submit"]:hover {
            background-color: #1565c0;
        }
    </style>
    <script>
        window.onload = function () {

            // --------------------------------------------------------------------------------- 이메일 나타나는 창구
            function consLog(msg) {
                document.querySelector(".cons").innerHTML = msg
            }

            // --------------------------------------------------------------------------------- 아이디 찾기 누르면 발생하는 거

            document.querySelector("#submit1").onclick = function (e) {
                e.preventDefault();

                let params = {
                    name: document.querySelector("#name").value.trim(),
                    question: document.querySelector("#question").value.trim(),
                    answer: document.querySelector("#answer").value.trim()
                };

                if (!params.name || !params.question || !params.answer) {
                    consLog("모든 항목을 입력하세요")
                    return;
                }

                fetch("/idpwsearch/findid", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(params)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // 이메일 일부 표시
                            const maskedEmails = data.emails.map(email => {
                                const [id, domain] = email.split("@");
                                let masked = "";

                                for (let i = 0; i < id.length; i++) {
                                    // 1,3,5번째만 공개 (인덱스는 0,2,4)
                                    if (i === 0 || i === 2 || i === 4) {
                                        masked += id[i] || ""; // 없는 경우 방지
                                    } else {
                                        masked += "*";
                                    }
                                }
                                return masked + "@" + domain;
                            });

                            consLog("이메일: <br>" + maskedEmails.join("<br>"));
                        } else {
                            consLog("일치하는 정보가 없습니다");
                        }
                    })
                    .catch(err => consLog("서버 오류"))
            };

            // --------------------------------------------------------------------------------- 비밀번호 찾기 누르면 발생하는 거

            // value값 받기(email, 비밀번호 찾기 버튼, 새비밀번호, 새비밀번호 확인, 비밀번호 변경)

            const emailInput = document.querySelector('#email')
            const confirmBtn = document.querySelector('#confirmcode')
            const verifyArea = document.querySelector('#verifyArea')
            const checkCodeBtn = document.querySelector('#checkCodeBtn')
            const codeInput = document.querySelector('#code')
            const newPwArea = document.querySelector('#newPwArea')
            const submit2 = document.querySelector('#submit2')
            const newpw1 = document.querySelector('#newpw1')
            const newpw2 = document.querySelector('#newpw2')
            const submit3 = document.querySelector('#submit3')

            let sentCode = ''
            // 새비밀번호 숨기고 있다가 이메일 입력 후 비밀번호 찾기 버튼 클릭 시 DB 확인 후 나타나기

            confirmBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const email = emailInput.value.trim();
                if (!email) return alert("이메일을 입력하세요.");

                fetch("/idpwsearch/sendCode", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            sentCode = data.code; // 서버에서 전송된 코드 저장 (실제 서비스에선 안보냄)
                            alert("인증번호가 이메일로 전송되었습니다.");
                            verifyArea.style.display = "block"; // 인증번호 입력칸 표시
                        } else {
                            alert("등록되지 않은 이메일입니다.");
                        }
                    })
                    .catch(err => console.error("에러:", err));
            });

            // 인증번호 확인 버튼 클릭 시 (새로 추가된 부분)
            checkCodeBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const inputCode = codeInput.value.trim();
                if (!inputCode) return alert("인증번호를 입력하세요.");

                fetch("/idpwsearch/verifyCode", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: emailInput.value.trim(), code: inputCode })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.valid) {
                            alert("이메일 인증이 완료되었습니다");
                            newPwArea.style.display = "block"; // 새 비밀번호 입력칸 표시
                            emailInput.readOnly = true;
                            confirmBtn.disabled = true;
                            codeInput.readOnly = true;
                            checkCodeBtn.disabled = true;
                        } else {
                            alert("인증번호가 올바르지 않습니다.");
                        }
                    })
                    .catch(err => console.error("에러:", err));
            });

            // 비밀번호 변경 
            submit3.addEventListener("click", (e) => {
                e.preventDefault();
                const email = emailInput.value.trim();
                const pw1 = newpw1.value.trim();
                const pw2 = newpw2.value.trim();

                if (!pw1 || !pw2) return alert("비밀번호를 입력하세요.");
                if (pw1 !== pw2) return alert("비밀번호가 일치하지 않습니다.");

                // 비밀번호 유효성 검사
                const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#&*])[A-Za-z\d!@#&*]{8,16}$/;
                if (!pwRegex.test(pw1)) {
                    return alert("비밀번호는 8~16자, 영문자/숫자/특수문자(!,@,#,&,*)를 포함해야 합니다.");
                }

                fetch(`/idpwsearch/changepw`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, newchangepw: pw1 })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert("비밀번호가 성공적으로 변경되었습니다!");
                            location.href = "/login";
                        } else {
                            alert(data.message || "비밀번호 변경 실패");
                        }
                    })
                    .catch(err => console.error("에러:", err));
            });


            // --------------------------------------------------------------------------------- 비밀번호 변경 누르면 발생하는 거



            // post로 해당 부분 값 보내서 db 비교 후 맞으면 생성 시키기(비밀번호 찾기 버튼 클릭)
            document.querySelector("#submit3").addEventListener("click", (e) => {
                e.preventDefault();

                const email = document.querySelector('#email').value.trim();
                const newchangepw = newpw1.value.trim()
                const newchangepw2 = newpw2.value.trim()

                if (!newchangepw || !newchangepw2) { return alert('비밀번호 입력') }
                if (newchangepw !== newchangepw2) { return alert('비밀번호 불일치') }

                fetch(`/idpwsearch/changepw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'

                    },
                    body: JSON.stringify({ newchangepw, email })

                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            location.href = "/login";
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(err => console.log('에러 :', err.message))

            })
        }
    </script>
</head>

<body>
    {% include '../header.html' %}
    
    <wrapper>
        <section>
            아이디찾기
            <form action="" method="post">
                <!--이름 입력란-->
                <input type="text" name="name" id="name" placeholder="이름">
                <br>
                <div>
                    <!-- 질문 선택 -->
                    <select id="question">
                        <option value="">---질문 선택---</option>
                        <option value="food" class="question">어떤 음식을 좋아합니까?</option>
                        <option value="hobby" class="question">어떤 취미가 있습니까?</option>
                        <option value="exercise" class="question">어떤 운동을 좋아합니까?</option>
                        <option value="music" class="question">좋아하는 음악 장르는 무엇입니까?</option>
                        <option value="season" class="question">좋아하는 계절은 무엇입니까?</option>
                        <option value="trip" class="question">가장 기억에 남는 여행은 무엇입니까?</option>
                        <option value="animal" class="question">어떤 동물을 좋아합니까?</option>
                        <option value="place" class="question">추억의 장소는 어디입니까?</option>
                        <option value="movie" class="question">가장 좋아하는 영화는 무엇입니까?</option>
                        <option value="color">좋아하는 색깔은 무엇입니까?</option>
                    </select>
                    <br>
                    <!-- 답변 입력 -->
                    <input type="text" name="answer" id="answer" placeholder="답변">
                    <br>
                    <!-- 이메일 표시 -->
                    <div class="cons">
                        <!-- 아이디(이메일) 표시 -->
                    </div>
                    <br>
                    <!-- 제출 버튼 -->
                    <input type="submit" value="아이디찾기" id="submit1">
            </form>
        </section>
        <section>
            비밀번호찾기
            <form action="" method="post" onsubmit="return false">
                <!--이메일 입력란-->
                <div class="row">
                <input type="email" name="email" id="email" placeholder="아이디(이메일)">
                <!--인증번호 받기 버튼-->
                <input type="button" id="confirmcode" value="인증번호" class="btn flex btn small">
                </div>
                <br>
                <!--인증번호 입력란-->
                <div id="verifyArea" class="row" style="display: none;">
                    <input type="text" id="code" placeholder="인증번호 입력">
                    <input type="button" id="checkCodeBtn" value="인증 확인">
                    <br>
                </div>
                <br>
                <!-- 비밀번호 찾기 버튼 -->
                <div id="newPwArea" style="display: none;">
                    <input type="password" name="newpw" id="newpw1" placeholder="새 비밀번호 (8~16자, 영문+숫자+특수문자)">
                    <br>
                    <input type="password" name="newpw2" id="newpw2" placeholder="새 비밀번호 확인">
                    <br>
                    <input type="submit" value="비밀번호 변경" id="submit3">
                </div>
            </form>
        </section>
    </wrapper>
    <footer>푸터영역</footer>
</body>

</html>